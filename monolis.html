<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONOLIS</title>
    <!--スタイルシートの読み込み-->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="quill.css">
    <link rel="stylesheet" href="menu.css">
    <script src="https://monolis.f5.si/js/api_access.js"></script>
    <script>const api = new MonolisAPI("monolis.f5.si/api");</script>
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <!-- <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/assets/css/suneditor.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/assets/css/suneditor-contents.css" rel="stylesheet"> -->
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <!-- languages (Basic Language: English/en) -->
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/src/lang/ja.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js" integrity="sha512-t5Lcu24FbQybGnoIbv1GXDx633tW0Hd4reBUx74EIq/2Q39FzskADNbjc605pQA9kkojC+8bRXhHKEXoKJs3rw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css" integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body>
    
    <header>
        <h1 class="title"> 
          <span id="filename" contenteditable="true"></span>
        </h1>
        <nav class="nav">
          <ul class="menu-group">
            <li class="menu-item"><a href="#">設定</a></li>
            <li class="menu-item"><a href="list.html">ものリスト</a></li>
          </ul>
        </nav>
    </header>

         <!--エディタコンテナの作成-->
         <div id="editor">
          <textarea id="content"></textarea>
        </div>
        
        
        <script>

          
          const urlParams = new URLSearchParams(window.location.search);
          const filename = urlParams.get("filename");
          const pageId = urlParams.get("id");

        function savePageData(contents, core){
          console.log(contents)
          // セーブ
          let pageId = page.id;
          let newPage = {
            "title": page.title,
            "content": contents,
            "access_type": page.access_type,
            "password": document.getElementById("password").value,
            "allowed_user_ids": page.allowed_user_ids,
            "co_editor_user_ids": page.co_editor_user_ids
          };

          api.updatePage(pageId, newPage).then(res => {
              if(res.status === 200){
                  // 成功の処理
              } else if(res.status === 404){
                  // ページが見つからない、または編集権限がない場合の処理
              } else if(res.status === 413){
                  alart("ページの容量が大きすぎます。コンテンツの量を減らしてください。");
              } else {
                  // その他のエラー処理
              }
          });

        }

        let page = null;
        let sunEditor = null;

        function updateSaveFlag() {
          // コンテンツを取得
          const content = sunEditor.getContents();
          sunEditor.setContents(" " + content);
          sunEditor.setContents(content);
        }


        document.getElementById("filename").addEventListener("input", function(event) {
          let editedContent = event.target.textContent;
          page.title = editedContent;
          updateSaveFlag();
        });

        function createPage(data){
          page = data; // ページのデータ
          selectPublishOption(page.access_type);
          // QRコードを描画するcanvas要素を取得
          const qrCode = document.getElementById("qrcode")
          qrCode.innerHTML = createQR(`https://monolis.f5.si/page.html?pageId=${page.id}`);

          document.getElementById("password").value = page.password;

          sunEditor = SUNEDITOR.create('content', {
            mode: "classic",
            value: page.content,
            callBackSave: savePageData,
            width: "100%",
            height: "70vh",
            charCounter: true,
            buttonList: [
                ['undo', 'redo'],
                ['font', 'fontSize', 'formatBlock'],
                ['paragraphStyle', 'blockquote'],
                ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
                ['fontColor', 'hiliteColor', 'textStyle'],
                ['removeFormat'],
                '/', // Line break
                ['outdent', 'indent'],
                ['align', 'horizontalRule', 'list', 'lineHeight'],
                ['table', 'link', 'image', 'video', 'audio' /** ,'math' */], // You must add the 'katex' library at options to use the 'math' plugin.
                /** ['imageGallery'] */ // You must add the "imageGalleryUrl".
                ['fullScreen', 'showBlocks', 'codeView'],
                ['preview', 'print'],
                ['save', 'template'],
                /** ['dir', 'dir_ltr', 'dir_rtl'] */ // "dir": Toggle text direction, "dir_ltr": Right to Left, "dir_rtl": Left to Right
            ],
            codeMirror: { // Custom option
                        src: CodeMirror,
                        options: {}
            },
            pasteTagsWhitelist :'*',
            attributesWhitelist: {
                '???': '*', // "*" === all attributes
                'button': 'onclick',
                'input': 'checked|name|type|value' // Apply to input tag
            },
            templates: [
                {
                    name: 'Template-1',
                    html: '<button onclick="console.log(`hello`);">Hello</button>'
                },
                {
                    name: 'Template-2',
                    html: '<p>HTML source2</p>'
                }
            ],
            lineAttrReset: '',
            __allowedScriptTag :true,
            addTagsWhitelist: 'mark|canvas|label|select|option|input|button|//',
            lang: SUNEDITOR_LANG['ja'],
            fullPage:true
          });
        }

        document.addEventListener("DOMContentLoaded", function() {
          // ファイル名を表示
          const filenameElement = document.getElementById("filename");
          filenameElement.textContent = filename;

          
          
          api.getPage(pageId).then(res => {
              if(res.status === 200){
                  // 成功の処理
                  createPage(res.page);
              } else if(res.status === 403){
                window.location.href = `login.html`
              } else if(res.status === 404){
                window.location.href = `list.html`
              } else if(res.status === 503){
                createPage({
                    "id": null,
                    "title": "",
                    "content": "",
                    "access_type": 0,
                    "password": null,
                    "allowed_user_ids": [],
                    "co_editor_user_ids": [],
                    "creator_id": null,
                    "thumbnail" : "",
                    "created_at": "",
                    "updated_at": ""});
                    filenameElement.textContent = "デバッグ用ページ（サーバに保存されません）";
              } else {
                window.location.href = `index.html`
              }
          });


           
        });
      </script>
        <button id="viewContentButton">内容を表示</button>
    
        <script>
          document.getElementById("viewContentButton").addEventListener("click", function() {
              sunEditor.save();
              // "content"要素の内容を取得
              const contentElement = document.getElementById("content");
              const content = contentElement.textContent;
    
              // URLパラメータに内容を追加して次のページに遷移
              window.location.href = `https://monolis.f5.si/page.html?pageId=${page.id}`;
          });
      </script>
    
    <!--管理画面スライドメニューのコード-->
    <div id="slide-menu" style="right: -240px;">
      <h2>管理画面</h2>
        
        <p>公開範囲設定<br>
          <label>
            <input type="radio" name="publishOption" onchange="updateCheckboxes(1)"> 公開
          </label><br>
          <label>
            <input type="radio" name="publishOption" onchange="updateCheckboxes(2)"> パスワード付き公開
          </label><br>
          <label>
            <input type="radio" name="publishOption" onchange="updateCheckboxes(3)"> ユーザー指定公開
          </label><br>
          
          <div id="text-container" style="display: none;">
            公開アカウント設定<br>
            <label for="page-allowed_user_ids">公開を許可するユーザー：</label>
            <input type="text" id="page-allowed_user_ids" required>
            <button onclick="addItem1()">追加</button>
            <ul id="allowed_user_ids_disp"></ul><br>
            <label for="page-co_editor_user_ids">共同編集を可能にするユーザー：</label>
            <input type="text" id="page-co_editor_user_idsd" required>
            <button onclick="addItem2()">追加</button>
            <ul id="co_editor_user_idsd_disp"></ul><br>
        
            <!-- 公開するユーザーのリストの追加 -->
            <script>
              var allowed_user_idsList = [];  // 空の配列を作成
        
              function addItem1() {
                var inputElement = document.getElementById("page-allowed_user_ids");
                var inputValue = inputElement.value;
        
                if (inputValue.trim() !== "") {
                  allowed_user_idsList.push(inputValue);  // テキスト情報を配列に追加
        
                  var newItem = document.createElement("li");
                  newItem.appendChild(document.createTextNode(inputValue));
        
                  var allowed_user_ids_disp = document.getElementById("allowed_user_ids_disp");
                  allowed_user_ids_disp.appendChild(newItem);
        
                  inputElement.value = "";
                  updateCheckboxes();
                }
              }
            </script>
        
            <!-- 共同編集するユーザーのリストの追加 -->
            <script>
              var co_editor_user_idsdsList = [];  // 空の配列を作成
        
              function addItem2() {
                var inputElement = document.getElementById("page-co_editor_user_idsd");
                var inputValue = inputElement.value;
        
                if (inputValue.trim() !== "") {
                  co_editor_user_idsdsList.push(inputValue);  // テキスト情報を配列に追加
        
                  var newItem = document.createElement("li");
                  newItem.appendChild(document.createTextNode(inputValue));
        
                  var co_editor_user_idsd_disp = document.getElementById("co_editor_user_idsd_disp");
                  co_editor_user_idsd_disp.appendChild(newItem);
        
                  inputElement.value = "";
                  updateCheckboxes();
                }
              }
            </script>
              

          </div>
          
          <div id="form-container">
            公開パスワード
            <form>
              <input type="text" id="password" placeholder="パスワードを入力">
            </form>
          </div>
          
          <input type="hidden" id="access_type" value="0"> <!-- 初期値は0 -->
        
          <script>
          // document.getElementById("password").onchange = () => {
          //   page.password = document.getElementById("password").value
          // };
          
          function selectPublishOption(optionNumber) {
            let radioButtons = document.getElementsByName("publishOption");
            updateCheckboxes(optionNumber + 1);
            console.log(optionNumber)
            try{
              radioButtons[optionNumber].checked = true;
            }catch{

            }
            

          }
          function updateCheckboxes(checkboxNumber) {
            let textContainer = document.getElementById("text-container");
            let formContainer = document.getElementById("form-container");
            let accessTypeInput = document.getElementById("access_type");
            
            if (checkboxNumber === 1) {
              textContainer.style.display = "none";
              formContainer.style.display = "none";
              page.access_type = "0";
            } else if (checkboxNumber === 2) {
              textContainer.style.display = "none";
              formContainer.style.display = "block";
              if (document.getElementById("password").value === "") {
                page.access_type = "0";
              } else {
                page.access_type = "1";
              }
            } else if (checkboxNumber === 3) {
              textContainer.style.display = "block";
              formContainer.style.display = "none";
              page.access_type = "2";
            }
            
            // if (allowed_user_idsList.length > 0 || co_editor_user_idsdsList.length > 0) {
            //   accessTypeInput.value = "2";
            // }

            // page.access_type = accessTypeInput.value;

            // access_typeの値をコンソールに表示
            console.log("access_type: " + page.access_type );
            if(sunEditor != null)updateSaveFlag();
          }
          </script>
        </p>

        <p>QRコード作成</p>
        <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.2/qrcode.min.js"></script>
        <div id="qrcode"></div>

        <!-- <script src="QR.js"></script>
        <link rel="stylesheet" href="QR.css"> -->

        <!-- CDNの場合 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.js"></script>
        <!-- <div class="qrblock">
          <p class="qrcomment">QRコードで生成したい文字列を入力してください。</p>
          <input id="isbn" type="text" name="isbn" value=""> <button id="getqrInfo" class="btn btn-default">QRコードを生成</button><br>
        </div> -->
        <div id="qrOutput">
          <canvas id="qr"></canvas>
          <div><img id="newImg"></div>
        </div>
        <script>

          function createQR(url){
            // QRコード生成オプション
            const qrOptions = {
              // QRコードの種類 (0 - 自動検出, 1 - 数字, 2 - 英数字, 3 - 8ビットバイト)
              typeNumber: 0,
              // QRコードの誤り訂正レベル (L - 7%, M - 15%, Q - 25%, H - 30%)
              errorCorrectionLevel: "H",
            };

            // QRコードを生成
            const qrCode = qrcode(0, qrOptions.errorCorrectionLevel);
            qrCode.addData(url);
            qrCode.make();

            // SVG形式のQRコードを取得
            return qrCode.createSvgTag();
          }
          
          /*
          document.getElementById('getqrInfo').addEventListener('click', () => {
          // 入力された文字列を取得
          var userInput = document.getElementById('isbn').value;
          var query = userInput.split(' ').join('+');
          // QRコードの生成
          (function() {
          var qr = new QRious({
          element: document.getElementById('qr'),
          // 入力した文字列でQRコード生成
          value: `https://monolis.f5.si/page.html?pageId=${page.id}`
          });
          qr.background = '#FFF'; //背景色
          qr.backgroundAlpha = 0.8; // 背景の透過率
          qr.foreground = '#6bb6ff'; //QRコード自体の色
          qr.foregroundAlpha = 1.0; //QRコード自体の透過率
          qr.level = 'L'; // QRコードの誤り訂正レベル
          qr.size = 100; // QRコードのサイズ
          // QRコードをflexboxで表示
          document.getElementById('qrOutput').style.display = 'flex';
          })();
          // png出力用コード
          //var cvs = document.getElementById("qr");
          var png = cvs.toDataURL();
          document.getElementById("newImg").src = png;

          });
          //*/
        </script>



        
    </div>
    

    <div id="menu">
      <!-- メニュー表示・非表示用のボタン -->
      <button id="menu-button" style="z-index: 100;">←</button>
    </div>
    

    <script src="menu.js"> </script>

   
</body>
</html>